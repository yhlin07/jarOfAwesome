# GitHub Actions Workflow for deploying to Cloud Run
# ÈÄôÂÄãÊ™îÊ°àÂëäË®¥ GitHubÔºö‰ªÄÈ∫ºÊôÇÂÄô„ÄÅÊÄéÈ∫ºÈÉ®ÁΩ≤‰Ω†ÁöÑ bot

name: Deploy to Cloud Run

# üìå Ëß∏ÁôºÊ¢ù‰ª∂Ôºö‰ªÄÈ∫ºÊôÇÂÄôÂü∑Ë°åÈÄôÂÄã workflowÔºü
on:
  push:
    branches:
      - main  # Áï∂‰Ω† push Âà∞ main branch ÊôÇ
  workflow_dispatch:  # ÊàñËÄÖ‰Ω†Âú® GitHub ‰ªãÈù¢ÊâãÂãïÈªû„ÄåRun workflow„Äç

# üîê Ê¨äÈôêË®≠ÂÆö
permissions:
  contents: read
  id-token: write  # ÈúÄË¶ÅÈÄôÂÄã‰æÜ‰ΩøÁî® Workload Identity

# üèÉ Ë¶ÅÂü∑Ë°åÁöÑ‰ªªÂãô
jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest  # ‰ΩøÁî® GitHub Êèê‰æõÁöÑ Ubuntu ËôõÊì¨Ê©ü

    steps:
      # Ê≠•È©ü 1Ô∏è‚É£Ôºö‰∏ãËºâ‰Ω†ÁöÑ‰ª£Á¢º
      - name: Checkout code
        uses: actions/checkout@v4
        # üìñ ÈÄô‰∏ÄÊ≠•Êää‰Ω†ÁöÑ repo ‰ª£Á¢ºË§áË£ΩÂà∞ GitHub ÁöÑËôõÊì¨Ê©ü‰∏ä

      # Ê≠•È©ü 2Ô∏è‚É£ÔºöË®≠ÂÆö Google Cloud Ë™çË≠â
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
        # üìñ ‰ΩøÁî®‰Ω†Âú® GitHub Secrets Ë®≠ÂÆöÁöÑ GCP ÈáëÈë∞‰æÜÁôªÂÖ•

      # Ê≠•È©ü 3Ô∏è‚É£ÔºöË®≠ÂÆö gcloud CLI
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        # üìñ ÂÆâË£ù‰∏¶Ë®≠ÂÆö gcloud Â∑•ÂÖ∑ÔºàÂ∞±ÊòØ‰Ω†ÈõªËÖ¶Ë£ù‰∏çÂ•ΩÁöÑÈÇ£ÂÄãÔºâ

      # Ê≠•È©ü 4Ô∏è‚É£ÔºöË®≠ÂÆö Docker buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Ê≠•È©ü 5Ô∏è‚É£ÔºöË™çË≠â Docker Âà∞ Artifact Registry
      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker asia-east1-docker.pkg.dev

      # Ê≠•È©ü 6Ô∏è‚É£ÔºöÂª∫ÁΩÆ‰∏¶Êé®ÈÄÅ Docker image
      - name: Build and Push Docker Image
        run: |
          docker build -t asia-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/jar-of-awesome:${{ github.sha }} .
          docker push asia-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/jar-of-awesome:${{ github.sha }}

      # Ê≠•È©ü 7Ô∏è‚É£ÔºöÈÉ®ÁΩ≤Âà∞ Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy jar-of-awesome \
            --image asia-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/jar-of-awesome:${{ github.sha }} \
            --platform managed \
            --region asia-east1 \
            --allow-unauthenticated \
            --min-instances 0 \
            --max-instances 1 \
            --memory 512Mi \
            --cpu 1 \
            --timeout 60s \
            --cpu-boost \
            --set-env-vars RUN_MODE=http \
            --set-env-vars TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
            --set-env-vars TELEGRAM_USER_ID=${{ secrets.TELEGRAM_USER_ID }} \
            --set-env-vars USE_PREGENERATED=1 \
            --set-env-vars DEBUG=0 \
            --set-env-vars TIMEZONE=America/Los_Angeles \
            --project ${{ secrets.GCP_PROJECT_ID }}
        # üìñ Áî®È†êÂÖàÂª∫ÁΩÆÂ•ΩÁöÑ Docker image ÈÉ®ÁΩ≤ÔºåÈÅøÂÖç Cloud Build Ê¨äÈôêÂïèÈ°å

      # Ê≠•È©ü 8Ô∏è‚É£ÔºöÂèñÂæó Service URL
      - name: Get Service URL
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe jar-of-awesome \
            --platform managed \
            --region asia-east1 \
            --format 'value(status.url)' \
            --project ${{ secrets.GCP_PROJECT_ID }})
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "üöÄ Deployed to: $SERVICE_URL"
        # üìñ ÂèñÂæóÈÉ®ÁΩ≤ÂæåÁöÑ URLÔºåÊñπ‰æø‰Ω†Áü•ÈÅìÊúçÂãôÂú®Âì™

      # Ê≠•È©ü 6Ô∏è‚É£ÔºöÊ∏¨Ë©¶ Health Check
      - name: Test Health Endpoint
        run: |
          sleep 10  # Á≠âÂæÖÊúçÂãôÂïüÂãï
          curl -f ${{ steps.get-url.outputs.url }}/ || echo "‚ö†Ô∏è Health check failed"
        # üìñ Ê∏¨Ë©¶ÊúçÂãôÊòØÂê¶Ê≠£Â∏∏ÈÅã‰Ωú

      # Ê≠•È©ü 9Ô∏è‚É£ÔºöË®≠ÂÆö Cloud Scheduler
      - name: Setup Cloud Scheduler Jobs
        run: |
          echo "‚è∞ Setting up Cloud Scheduler for daily affirmations..."

          SERVICE_URL="${{ steps.get-url.outputs.url }}"
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
          REGION="asia-east1"
          TIMEZONE="America/Los_Angeles"

          # Note: Cloud Scheduler API must be enabled manually in GCP Console
          # Visit: https://console.cloud.google.com/apis/library/cloudscheduler.googleapis.com

          echo ""
          echo "üóëÔ∏è  Deleting old jobs to ensure correct timezone..."
          # Delete old jobs first (timezone cannot be updated, must recreate)
          for LABEL in "morning" "noon" "afternoon" "evening"; do
            JOB_NAME="jar-of-awesome-$LABEL"
            echo "  Deleting $JOB_NAME..."
            gcloud scheduler jobs delete $JOB_NAME \
              --location=$REGION \
              --project=$PROJECT_ID \
              --quiet 2>/dev/null && echo "    ‚úÖ Deleted" || echo "    ‚ö†Ô∏è  Not found (skipping)"
          done

          echo ""
          echo "‚ú® Creating new jobs with correct timezone ($TIMEZONE)..."
          # Create 4 jobs for 8am, 12pm, 4pm, 8pm
          for TIME_INFO in "morning:8" "noon:12" "afternoon:16" "evening:20"; do
            IFS=':' read -r LABEL HOUR <<< "$TIME_INFO"
            JOB_NAME="jar-of-awesome-$LABEL"

            echo "  Creating $JOB_NAME at ${HOUR}:00 $TIMEZONE..."

            gcloud scheduler jobs create http $JOB_NAME \
              --location=$REGION \
              --schedule="0 ${HOUR} * * *" \
              --uri="$SERVICE_URL/cron/send-affirmation" \
              --http-method=POST \
              --time-zone="$TIMEZONE" \
              --attempt-deadline=60s \
              --project=$PROJECT_ID && echo "    ‚úÖ Created" || echo "    ‚ùå Failed"
          done

          echo ""
          echo "‚úÖ Cloud Scheduler setup complete!"
          echo "üìã Listing all jobs to verify:"
          gcloud scheduler jobs list --location=$REGION --project=$PROJECT_ID --format="table(name,schedule,timeZone)"
        # üìñ Ëá™ÂãïË®≠ÂÆö 4 ÂÄãÂÆöÊôÇ‰ªªÂãôÔºåÊØèÂ§©Âú®ÊåáÂÆöÊôÇÈñìËß∏ÁôºÁôºÈÄÅ

      # Ê≠•È©ü üîüÔºöÈ°ØÁ§∫ÈÉ®ÁΩ≤Ë≥áË®ä
      - name: Deployment Summary
        run: |
          echo "üéâ ÂÆåÊï¥ÈÉ®ÁΩ≤ÊàêÂäüÔºÅ"
          echo ""
          echo "‚úÖ ÈÉ®ÁΩ≤Ë≥áË®äÔºö"
          echo "  üìç Service URL: ${{ steps.get-url.outputs.url }}"
          echo "  ‚è∞ ÂÆöÊôÇÁôºÈÄÅ: 08:00, 12:00, 16:00, 20:00 (America/Los_Angeles)"
          echo "  üí∞ È†ê‰º∞Ë≤ªÁî®: ~\$0.10/month"
          echo ""
          echo "üß™ Ê∏¨Ë©¶Êåá‰ª§Ôºö"
          echo "  ÊâãÂãïËß∏Áôº: curl -X POST ${{ steps.get-url.outputs.url }}/cron/send-affirmation"
          echo ""
          echo "üìä Êü•Áúã logs:"
          echo "  gcloud run services logs read jar-of-awesome --region asia-east1"
